# B站动态内容爬取工具

*Power by iflow, Trae and GLM-4.5*

## 项目起源

本项目最初是为爬取B站用户"阳阳不想熬夜"（UID: 618107325）的动态内容而创建的，随着功能不断完善，现已演变为一个通用的B站动态爬取工具，同时保留了部分针对此用户的设置。项目包含两个核心脚本：

1. `raw_bilibili_scraper.py` - 原始HTML数据爬虫
2. `bilibili_dynamic_parser.py` - HTML文件解析工具

## 功能说明

### raw_bilibili_scraper.py
这是主要的爬虫脚本，用于获取B站用户动态的原始HTML数据：
- 支持三种爬取模式：传统模式、快速模式和半自动模式
- 直接保存页面原始HTML内容，不进行任何数据处理
- 自动识别用户名，支持从页面标题提取
- 智能滚动加载所有动态内容，自动检测是否到达底部
- 保存原始HTML文件和元数据JSON文件
- 适用于需要原始数据进行分析的场景

### bilibili_dynamic_parser.py
这是HTML文件解析工具，用于从已保存的HTML文件中提取动态信息：
- 解析B站动态页面HTML文件，提取多种类型的动态内容
- 支持识别置顶动态、纯文本动态、带图片的文本动态、投稿视频动态和动态视频
- 过滤排除指定的图片链接（如头像和装扮图片，暂仅针对"阳阳不想熬夜"用户，可在”排除的图片链接.txt“中添加要排除的图片链接）
- 提取用户名、发布时间、文本内容、图片链接、点赞数、评论数、分享数、视频信息等
- 在HTML文件同路径下生成预览文本文件
- 使用集合存储图片链接，自动去除同一动态下重复的图片链接
- 适用于已获取HTML文件但需要重新解析或格式化的场景

## 针对性设置

虽然项目已发展为通用工具，但仍保留了部分针对"阳阳不想熬夜"用户的设置：

1. **置顶动态识别**：特定识别2022年05月14日发布的包含特定文本内容（"永远要相信自己 并且坚定的往自己想要去的方向前进 梦想一旦开始就很难停止"）的动态为置顶动态
2. **默认UID**：脚本默认使用"阳阳不想熬夜"的UID（618107325）作为爬取目标
3. **排除图片列表**：包含针对该用户动态中常见的非内容图片的过滤规则

## 安装依赖

```bash
pip install -r requirements.txt
```

## 使用方法

### 原始HTML数据爬虫

```bash
python raw_bilibili_scraper.py
```

运行后会提示输入用户UID（默认为618107325）和选择爬取模式：

1. 传统模式 - 智能滚动加载，适合大多数情况
2. 快速模式 - 一次性滚动到底部，速度更快
3. 半自动模式（默认）- 手动滚动页面后提取数据

⚠️ **注意**：当目标用户的动态内容过多（例如超过200条）时，建议使用半自动模式进行爬取，以避免自动滚动过程中出现人机验证导致的卡顿问题。

### HTML文件解析工具

```bash
python bilibili_dynamic_parser.py HTML文件路径
```

例如：

```bash
python bilibili_dynamic_parser.py "阳阳不想熬夜_原始数据_20250903_200913\阳阳不想熬夜_原始页面HTML.html"
```

#### 高级用法

```bash
python bilibili_dynamic_parser.py HTML文件路径 [选项]
```

#### 可用选项

- `-e, --exclude`: 指定排除图片链接文件路径（默认：排除的图片链接.txt）
- `-o, --output`: 指定输出文件路径（默认：HTML文件同目录下）

#### 示例

```bash
# 使用自定义的排除图片链接文件
python bilibili_dynamic_parser.py "阳阳不想熬夜_原始数据_20250903_200913\阳阳不想熬夜_原始页面HTML.html" -e "自定义排除图片.txt"

# 指定输出文件路径
python bilibili_dynamic_parser.py "阳阳不想熬夜_原始数据_20250903_200913\阳阳不想熬夜_原始页面HTML.html" -o "输出预览.txt"
```

## 输出文件

### 原始HTML数据爬虫输出
- `[用户名]_原始数据_[时间戳]/[用户名]_原始页面HTML.html` - 完整的页面HTML内容
- `[用户名]_原始数据_[时间戳]/[用户名]_原始数据元数据.json` - 爬取元数据

### HTML文件解析工具输出
- `[HTML文件同目录]/[HTML文件名]_预览.txt` - 格式化的动态内容预览文本文件

## 动态分类功能

脚本能够自动识别并分类以下类型的动态：

1. **置顶动态** 📌
   - 用户置顶的特殊动态
   - 包含完整的文本内容、图片链接和互动数据

2. **纯文本动态** 📝
   - 仅包含文本内容的动态
   - 提取文本内容、点赞数、评论数和分享数

3. **带图片的文本动态** 📝
   - 包含文本和图片的动态
   - 提取文本内容、过滤后的图片链接和互动数据

4. **投稿视频动态** 📺
   - 投稿自创视频时自动发送的动态
   - 提取视频标题、封面图链接、视频时长和互动数据

5. **动态视频** 📹
   - 发送动态视频时自动发送的动态
   - 提取视频标题、封面图链接、视频时长和互动数据

## 详细信息提取

对于每种类型的动态，脚本会提取以下信息（在数据可用的情况下）：

- **用户名** - 动态发布者的用户名
- **发布时间** - 动态发布的日期和时间
- **文本内容** - 动态的文本内容（清理后）
- **图片链接** - 过滤后的图片链接（排除头像和装扮图片）
- **点赞数** - 动态获得的点赞数量
- **评论数** - 动态的评论数量
- **分享数** - 动态的分享数量
- **视频标题** - 视频动态的标题（仅视频类型）
- **封面图链接** - 视频的封面图链接（仅视频类型）
- **视频总时长** - 视频的时长（仅视频类型）

## 数据格式说明

### 原始数据元数据格式
```json
{
  "uid": "618107325",
  "username": "用户名",
  "timestamp": "20250901_014227",
  "extraction_time": 1725148947.123,
  "url": "https://space.bilibili.com/618107325/dynamic",
  "html_size": 1234567
}
```

## 系统要求

- Python 3.7+
- Chrome浏览器
- Windows（测试通过）/Linux/macOS

## 注意事项

1. 确保已安装Chrome浏览器
2. 网络连接正常
3. 防火墙允许ChromeDriver运行
4. 爬取大量数据时可能需要较长时间

## 故障排除

### 浏览器初始化失败
- 确保已安装Chrome浏览器
- 检查网络连接
- 检查防火墙设置

### 数据提取失败
- 尝试使用不同的爬取模式
- 检查目标用户是否存在动态
- 尝试减少爬取范围

### 保存文件失败
- 检查目录权限
- 确保磁盘空间充足
- 检查文件名是否包含特殊字符

## 技术优化

### 动态数量计算优化

通过分析实际HTML结构，优化了动态数量计算的正则表达式：

```python
r'<div class="bili-dyn-list__item"><div class="bili-dyn-item">'
```

该正则表达式精确匹配B站动态的HTML结构，只匹配动态列表容器内的动态项，避免了误匹配其他div元素。

### 用户名提取优化

修复了从HTML标题中提取用户名的正则表达式：

```python
r'<title>(.+?)个人动态-'
```

```python
if "个人动态-" in page_title:
    username = page_title.split("个人动态-")[0]
```

### 图片链接去重优化

修改了`bilibili_dynamic_parser.py`脚本中的`_extract_images`方法，使用集合(set)来存储图片链接，自动去除重复的链接。解决了同一张图片在HTML中同时存在于img元素的src属性和source元素的srcset属性时被重复提取的问题。

### 图片过滤

脚本会自动过滤排除指定的图片链接，包括：

- 用户头像
- 装扮图片
- 其他非内容相关的图片

排除列表从 `排除的图片链接.txt` 文件中加载。